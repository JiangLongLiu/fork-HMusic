# xiaomusic 使用文档

## 📖 目录
- [项目简介](#项目简介)
- [系统要求](#系统要求)
- [快速开始](#快速开始)
- [Web界面配置](#web界面配置)
- [音乐管理](#音乐管理)
- [语音控制指令](#语音控制指令)
- [高级功能](#高级功能)
- [故障排除](#故障排除)
- [维护管理](#维护管理)
- [常见问题](#常见问题)

## 🎵 项目简介

xiaomusic 是一个开源项目，让您可以通过小爱音箱播放本地和在线音乐。主要特点：

- 🎤 **语音控制**：通过小爱音箱语音指令控制音乐播放
- 🎵 **多格式支持**：支持 mp3、flac、wav、ape、ogg、m4a 格式
- 🌐 **Web管理**：提供Web界面进行配置和管理
- 📱 **移动友好**：支持手机浏览器访问
- 🔄 **自动下载**：可自动从网络下载找不到的歌曲
- 📂 **播放列表**：支持创建和管理多个播放列表

## 🖥️ 系统要求

### OpenWrt设备
- OpenWrt 路由器或设备
- 至少 512MB RAM
- 2GB 存储空间（用于音乐文件）
- Docker 支持

### 小爱音箱
- 支持的型号：小爱音箱 Pro、Play、mini 等
- 已绑定小米账号
- 与OpenWrt设备在同一网络

### 客户端
- 支持现代浏览器的设备（电脑、手机、平板）

## 🚀 快速开始

### 1. 部署到OpenWrt

```bash
# 1. 配置SSH免密登录
./setup-ssh-key.sh

# 2. 一键部署xiaomusic
./quick_deploy_xiaomusic.sh
```

### 2. 初始配置

1. 打开浏览器访问：`http://192.168.31.2:58090`
2. 输入小米账号和密码
3. 点击"保存"，系统会自动获取设备列表
4. 选择要控制的小爱音箱设备
5. 保存配置完成初始化

### 3. 测试

对小爱音箱说："播放歌曲"，如果听到回应，说明配置成功！

## 🌐 Web界面配置

### 访问地址
```
http://192.168.31.2:58090
```

### 主要配置项

| 配置项 | 说明 | 必填 |
|--------|------|------|
| 小米账号 | 绑定小爱音箱的小米账号 | ✅ |
| 小米密码 | 账号对应密码 | ✅ |
| 设备选择 | 要控制的小爱音箱设备 | ✅ |
| 音乐目录 | 本地音乐存储路径 | ❌ |
| 下载功能 | 是否启用自动下载 | ❌ |
| 音质设置 | 下载音乐的音质偏好 | ❌ |
| 代理设置 | 网络代理配置 | ❌ |

### 安全设置

如果需要公网访问，建议启用身份验证：

1. 勾选"启用身份验证"
2. 设置用户名和密码
3. 使用复杂密码保护账号安全

## 🎵 音乐管理

### 支持的音频格式

- **mp3** - 最通用的格式
- **flac** - 无损音质格式
- **wav** - 未压缩音频
- **ape** - 无损压缩格式
- **ogg** - 开源音频格式
- **m4a** - Apple格式

### 上传音乐文件

#### 方法1：使用管理脚本（推荐）
```bash
# 上传单个文件
./xiaomusic_manager.sh upload 歌曲.mp3

# 上传多个文件
./upload_music_fix.sh *.mp3 *.flac
```

#### 方法2：打包上传（解决中文文件名问题）
```bash
# 打包所有音乐文件
tar -czf music.tar.gz *.mp3 *.flac

# 上传并解压
scp music.tar.gz root@192.168.31.2:/tmp/
ssh root@192.168.31.2 "cd /opt/xiaomusic/music && tar -xzf /tmp/music.tar.gz && rm /tmp/music.tar.gz"
```

#### 方法3：直接scp上传
```bash
scp 歌曲.mp3 root@192.168.31.2:/opt/xiaomusic/music/
```

### 文件命名建议

- **格式**：`歌手名-歌曲名.扩展名`
- **示例**：`周杰伦-晴天.mp3`
- **避免**：特殊字符 `/ ? < > \ : * | "`
- **支持**：中文文件名完全支持

### 创建播放列表

```bash
# 在服务器上创建分类文件夹
ssh root@192.168.31.2 "mkdir -p /opt/xiaomusic/music/流行"
ssh root@192.168.31.2 "mkdir -p /opt/xiaomusic/music/摇滚"
ssh root@192.168.31.2 "mkdir -p /opt/xiaomusic/music/收藏"

# 上传歌曲到对应文件夹
scp 流行歌曲.mp3 root@192.168.31.2:/opt/xiaomusic/music/流行/
```

## 🎤 语音控制指令

### 基础播放控制

| 语音指令 | 功能说明 |
|----------|----------|
| "播放歌曲" | 播放本地随机歌曲 |
| "播放歌曲+歌名" | 播放指定歌曲，如"播放歌曲晴天" |
| "上一首" | 切换到上一首歌曲 |
| "下一首" | 切换到下一首歌曲 |
| "停止播放" 或 "关机" | 停止当前播放 |

### 播放模式控制

| 语音指令 | 功能说明 |
|----------|----------|
| "单曲循环" | 重复播放当前歌曲 |
| "全部循环" | 循环播放整个列表 |
| "随机播放" | 随机顺序播放歌曲 |

### 播放列表控制

| 语音指令 | 功能说明 |
|----------|----------|
| "播放列表+列表名" | 播放指定列表，如"播放列表流行" |
| "播放列表收藏" | 播放收藏歌单 |
| "播放列表第几个+列表名" | 播放列表中指定位置的歌曲 |

### 收藏功能

| 语音指令 | 功能说明 |
|----------|----------|
| "加入收藏" | 将当前播放歌曲加入收藏 |
| "取消收藏" | 从收藏中移除当前歌曲 |

### 搜索功能

| 语音指令 | 功能说明 |
|----------|----------|
| "搜索播放+关键词" | 搜索并播放匹配的歌曲 |
| "本地搜索播放+关键词" | 只在本地音乐中搜索 |
| "播放本地歌曲+歌名" | 只播放本地歌曲，不下载 |

### 系统控制

| 语音指令 | 功能说明 |
|----------|----------|
| "刷新列表" | 重新扫描音乐目录，识别新添加的歌曲 |

## 🔧 高级功能

### 网络歌单配置

在Web界面中可以配置网络歌单：

1. 支持JSON格式的在线歌单
2. 支持电台播放
3. 可以使用他人分享的歌单链接

**JSON歌单格式示例**：
```json
{
  "name": "我的歌单",
  "songs": [
    {
      "name": "歌曲名",
      "url": "http://example.com/song.mp3"
    }
  ]
}
```

### 音质设置

- **标准音质**：平衡文件大小和音质
- **高音质**：更好的音质，文件较大
- **超高音质**：最佳音质，文件最大

### 代理配置

如果需要通过代理下载音乐：

1. 在Web界面中配置代理服务器
2. 支持HTTP和SOCKS代理
3. 格式：`http://proxy.example.com:8080`

### 格式兼容性

部分设备可能不支持某些格式，解决方案：

1. 启用"转换为MP3"选项
2. 启用"型号兼容模式"
3. 手动转换格式后上传

## 🛠️ 故障排除

### 常见问题及解决方案

#### 1. 小爱音箱无响应

**症状**：说语音指令没有反应

**解决方案**：
```bash
# 检查容器状态
./xiaomusic_manager.sh status

# 查看日志
./xiaomusic_manager.sh logs

# 重启容器
./xiaomusic_manager.sh restart
```

**检查项**：
- [ ] 小米账号密码是否正确
- [ ] 设备是否在同一网络
- [ ] 设备是否在线
- [ ] 配置是否保存成功

#### 2. 无法访问Web界面

**症状**：浏览器无法打开配置页面

**解决方案**：
```bash
# 检查容器端口
ssh root@192.168.31.2 "docker ps | grep xiaomusic"

# 检查防火墙
ssh root@192.168.31.2 "iptables -L | grep 58090"
```

**检查项**：
- [ ] IP地址是否正确
- [ ] 端口58090是否开放
- [ ] 容器是否正常运行

#### 3. 音乐下载失败

**症状**：语音点歌后无法播放

**解决方案**：
```bash
# 查看下载日志
./xiaomusic_manager.sh logs | grep -i download

# 检查网络连接
ssh root@192.168.31.2 "ping -c 3 8.8.8.8"
```

**检查项**：
- [ ] 网络连接是否正常
- [ ] 是否需要配置代理
- [ ] 存储空间是否充足

#### 4. 中文文件名上传失败

**症状**：scp上传中文文件名失败

**解决方案**：
```bash
# 使用修复脚本
./upload_music_fix.sh *.mp3

# 或使用打包方式
tar -czf music.tar.gz *.mp3
scp music.tar.gz root@192.168.31.2:/tmp/
ssh root@192.168.31.2 "cd /opt/xiaomusic/music && tar -xzf /tmp/music.tar.gz"
```

### 日志分析

#### 查看实时日志
```bash
./xiaomusic_manager.sh logs -f
```

#### 搜索特定错误
```bash
./xiaomusic_manager.sh logs | grep -i error
./xiaomusic_manager.sh logs | grep -i "failed"
```

#### 下载日志文件
在Web界面底部点击"下载日志文件"按钮获取完整日志。

## 🔧 维护管理

### 日常维护脚本

```bash
# 查看系统状态
./xiaomusic_manager.sh info

# 查看容器状态
./xiaomusic_manager.sh status

# 查看音乐库统计
ssh root@192.168.31.2 "find /opt/xiaomusic/music -name '*.mp3' -o -name '*.flac' | wc -l"
```

### 备份和恢复

#### 创建备份
```bash
# 备份配置和音乐
./xiaomusic_manager.sh backup
```

#### 恢复备份
```bash
# 从备份文件恢复
./xiaomusic_manager.sh restore xiaomusic_backup_20250801_120000.tar.gz
```

### 更新系统

```bash
# 更新到最新版本
./xiaomusic_manager.sh update
```

### 存储管理

#### 清理下载缓存
```bash
# 清理失败的下载
ssh root@192.168.31.2 "find /opt/xiaomusic/music/download -type d -empty -delete"

# 查看存储使用情况
ssh root@192.168.31.2 "du -sh /opt/xiaomusic/*"
```

#### 音乐库整理
```bash
# 查找重复文件
ssh root@192.168.31.2 "find /opt/xiaomusic/music -name '*.mp3' -exec basename {} \; | sort | uniq -d"

# 按大小排序找大文件
ssh root@192.168.31.2 "find /opt/xiaomusic/music -type f -exec ls -lh {} \; | sort -k 5 -h"
```

## ❓ 常见问题

### Q: 支持哪些小爱音箱型号？
A: 支持大部分小爱音箱型号，包括：
- 小爱音箱 Pro
- 小爱音箱 Play 系列
- 小爱音箱 mini
- 小米AI音箱
- Xiaomi Sound 系列

### Q: 可以同时控制多个音箱吗？
A: 目前一个实例只能控制一个音箱设备，如需控制多个设备，需要部署多个实例。

### Q: 音乐会自动下载吗？
A: 是的，当本地找不到指定歌曲时，系统会自动尝试从网络下载。

### Q: 支持歌词显示吗？
A: 部分音箱支持歌词显示，主要通过音箱自身的屏幕功能实现。

### Q: 可以设置定时播放吗？
A: 可以通过小爱音箱自带的定时功能实现，如"定时1小时后停止播放"。

### Q: 如何提高语音识别准确率？
A: 建议：
- 文件名使用常见的歌曲名和歌手名
- 语音指令要清晰准确
- 避免环境噪音干扰

### Q: 支持播放网络电台吗？
A: 支持，可以在网络歌单中配置电台链接。

### Q: 如何卸载系统？
A: 运行卸载命令：
```bash
./xiaomusic_manager.sh remove
```

## 📞 技术支持

### 获取帮助

1. **查看官方文档**：https://github.com/hanxi/xiaomusic
2. **提交Issues**：https://github.com/hanxi/xiaomusic/issues
3. **QQ群交流**：xiaomusic官方交流群
4. **查看FAQ**：GitHub Issues中的FAQ合集

### 报告问题

提交问题时请包含：
- 系统版本信息
- 错误日志文件
- 具体的操作步骤
- 预期结果和实际结果

### 贡献代码

欢迎提交Pull Request，改进项目功能。

---

**免责声明**：本项目仅供学习和研究使用，请遵守当地法律法规，合理使用音乐资源。

**版权声明**：xiaomusic项目采用MIT许可证，使用时请遵循开源协议。

---

*最后更新：2025年8月1日*