### 小爱音乐控制器 - 客户端重构计划

本计划基于《客户端页面与接口说明.md》，目标是降低耦合、提高可维护性与可测试性，保证功能无回归。

---

## 总目标
- **架构**：分层清晰（适配层/服务层/状态层/UI层），Provider 关注点单一。
- **体验**：错误与加载态统一处理，页面状态持久，操作有回执。
- **可测**：关键逻辑具备单元测试与可模拟的 API 依赖。
- **可扩展**：新增页面/接口最小改动即接入。

---

## 里程碑与阶段

### 阶段 1：基础设施与依赖注入（DI）
- **任务**
  - 引入统一路由（可选 `go_router`），抽离路由配置到 `lib/app_router.dart`。（保留 `IndexedStack` 行为）
  - 明确 DI 边界：新增 `dioClientProvider`，与 `apiServiceProvider` 组合自 `authProvider` 的鉴权信息。
  - 在 `main.dart` 中统一注入 Provider，删除 UI 层对 `DioClient` 的直接感知。
  - 规范日志：为 `DioClient` 增加可开关的日志级别（开发启用、生产降噪）。
- **交付物**
  - `lib/app_router.dart` 与路由接入
  - `lib/presentation/providers/dio_provider.dart`（或并入现有 `providers`）
  - 运行无功能回归
- **验收标准**
  - 原有登录、控制、搜索、列表、曲库全部可用
  - 切换账号/地址后，依赖实例随状态正确更新

### 阶段 2：Provider 拆分与状态整洁化
- **任务**
  - 从 `playbackProvider` 拆出 `deviceProvider`（仅负责设备列表、选择、在线状态）。
  - `playbackProvider` 专注播放状态、控制命令与进度轮询；轮询采用可控计时器（播放中 3s）。
  - 统一错误与加载标记：引入 `AsyncValue` 或 Result 模式，减少 `isLoading/error` 重复字段。
- **交付物**
  - `lib/presentation/providers/device_provider.dart`
  - 调整 `ControlPanelPage` 设备选择逻辑
- **验收标准**
  - 控制页设备选择/自动选择逻辑保持一致
  - 播放控制无回归，错误信息可清除

### 阶段 3：API 响应适配层（Adapter）
- **任务**
  - 新增 `lib/data/adapters/*`：
    - `music_list_adapter.dart`：统一 `/musiclist` 多格式（`所有歌曲`/`全部`/`music_list`/`songs`/`data` 等）到 `List<Music>`。
    - `playlist_adapter.dart`：统一 `/playlistnames` 与 `/musiclist` 的聚合，输出 `List<Playlist>` 与 Map<列表名, List<歌曲>>。
    - `search_adapter.dart`：统一 `/searchmusic` 的 `List<dynamic>` 到 `List<Music>`。
  - Provider 不再手写兼容分支，全部通过适配器完成。
- **交付物**
  - 适配层文件与单元测试（见阶段 6）
- **验收标准**
  - 现有页面逻辑简化，可读性提升
  - 不同服务端返回格式下功能保持可用

### 阶段 4：播放列表详情与操作完善
- **任务**
  - 新增页面 `lib/presentation/pages/playlist_detail_page.dart`：展示列表歌曲、支持播放整表/单曲。
  - `playlistProvider` 补充增删歌曲、重命名等 UI 操作串联（调用 Service 已具备）。
  - `MainPage` 列表卡片点击跳转详情页。
- **交付物**
  - 详情页与导航接入
- **验收标准**
  - 进入详情可显示歌曲数量与列表
  - 可播放整表，操作成功/失败有提示

### 阶段 5：播放进度拖动（Seek）
- **任务**
  - 若服务端具备 seek API：在 `MusicApiService` 增加 `seek(did, seconds)`，控制面板进度条 `onChangeEnd` 调用。
  - 若暂不具备：抽象接口并灰置 UI（禁用态提示“服务端不支持”）。
- **交付物**
  - 进度条拖动联动（或禁用占位）
- **验收标准**
  - 服务端支持时可正常拖动切换进度，无明显延迟与回滚

### 阶段 6：错误/Loading 统一与测试补齐
- **任务**
  - Provider 返回 `AsyncValue<T>` 或自定义 `Result<T>`；页面统一 `loading/error/empty/content` 四态渲染函数。
  - 单元测试：
    - 适配器：多种输入格式快照/断言
    - Service：使用 `dio` 拦截器/Mock 验证参数与错误映射
    - Provider：关键动作（播放/暂停/下一首/列表加载）状态转移
- **交付物**
  - 测试文件于 `test/`，CI 可本地运行通过
- **验收标准**
  - `flutter test` 通过，主要分支覆盖关键路径

### 阶段 7（可选）：UI 打磨与国际化
- **任务**
  - 统一主题、阴影与过渡动画，移动端细节优化
  - 提取文案支持 i18n（中文/英文）

### 阶段 8（可选）：打包与 CI
- **任务**
  - 配置简单 CI（lint/test 构建）
  - 产出 iOS/Android/macos 可用包

---

## 时间与交付建议（可微调）
- 阶段 1：0.5–1 天
- 阶段 2：1 天
- 阶段 3：1 天
- 阶段 4：1–1.5 天
- 阶段 5：0.5 天（取决于服务端）
- 阶段 6：1 天
- 预估总计：5–6 天（不含可选阶段）

---

## 风险、回滚与度量
- **风险**：服务端返回格式差异、播放状态延迟（设备/网络）、进度拖动接口不一致
- **回滚**：阶段性交付，每阶段保留可运行快照；关键 Provider/Service 保持旧接口期间兼容期
- **度量**：控制台错误数、SnackBar 错误率、平均 API 响应时间、用户操作到反馈时延

---

## 定义完成（DoD）
- 所有阶段 PR/变更通过 `flutter analyze` 与 `flutter test`
- 页面在 iOS/Android/macos 至少一种真机/模拟器验证
- 文档更新：
  - `docs/客户端页面与接口说明.md` 同步
  - `README.md` 更新运行与使用说明（若有新增能力）

---

## 立即下一步（阶段 1 落地清单）
- [ ] 新建 `lib/app_router.dart`，抽离路由（保留 `AuthWrapper` 登录态判定）
- [ ] 新建 `dioClientProvider`，由 `authProvider` 的鉴权信息构建 `DioClient`
- [ ] 调整 `apiServiceProvider`：依赖 `dioClientProvider` 注入
- [ ] `main.dart` 精简：仅保留主题与 `MaterialApp.router` 接入
- [ ] 验证全流程：登录→控制→搜索→列表→曲库

如需，我可以在此计划基础上直接开始第 1 阶段的代码改造。


