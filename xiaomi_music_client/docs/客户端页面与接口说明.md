### 客户端功能与接口说明（重构参考）

以下面向重构，逐页列清功能、状态、接口、数据模型与关键交互，确保可据此替换实现而不丢失行为。

### 登录页 `LoginPage`
- **功能**
  - 输入服务器地址、用户名、密码
  - 表单校验、提交登录
  - 失败提示、自动登录（本地凭据）
- **状态/Provider**
  - `authProvider`（`AuthState`）
    - `AuthInitial | AuthLoading | AuthAuthenticated | AuthError`
- **入口与跳转**
  - `lib/main.dart` 中 `AuthWrapper` 依据 `authProvider` 跳转至 `MainPage` 或显示加载/登录
- **接口**
  - `GET /getversion`（用于连通性与鉴权验证）
- **本地存储**
  - `SharedPreferences` 键：`server_url`、`username`、`password`
- **失败处理**
  - `DioClient` 将 HTTP/网络错误映射为 `AppException`，最终在界面以 `AuthError(message)` 呈现

### 主页 `MainPage`
- **结构**
  - 顶部标题/刷新/用户菜单（含退出登录）
  - 二级区域（控制页面设备选择/搜索页搜索框）
  - 内容区 Tab（`IndexedStack` 保持状态）
    - 0 控制：`ControlPanelPage`
    - 1 搜索：`MusicSearchPage`
    - 2 播放列表：`PlaylistPage`
    - 3 音乐库：`MusicLibraryPage`
  - 底部导航
- **交互**
  - 搜索框防抖 400ms：`musicSearchProvider.searchMusic(query)`
  - 刷新按钮：当在“列表”页时触发 `playlistProvider.refreshPlaylists()`
- **依赖状态**
  - `authProvider`（显示用户名、服务地址；支持退出登录）

### 控制面板页 `ControlPanelPage`
- **功能**
  - 设备列表加载/选择
  - 当前播放信息、进度条（只读滑杆，Seek 预留 TODO）
  - 播放控制：播放/暂停、上一首、下一首
  - 音量调节
  - 播放模式切换（顺序/全部循环/随机/单曲）
  - 获取/刷新播放状态（播放中每 3 秒自动刷新）
- **状态/Provider**
  - `playbackProvider`（`PlaybackState`）
    - 字段：`currentMusic: PlayingMusic?`、`volume`、`devices: List<Device>`、`selectedDeviceId`、`playMode`、`isLoading`、`error`
- **初始化**
  - `initState` 延迟 500ms 调用 `loadDevices()`、`ensureInitialized()`
  - 如 `currentMusic.isPlaying` 为真，定时器每 3 秒刷新状态
- **方法与接口映射**
  - 设备
    - `loadDevices()` → `GET /getsetting?need_device_list=true` → 解析 `device_list`
  - 状态
    - `refreshStatus()` → `GET /playingmusic?did=xxx` → `PlayingMusic.fromJson`
    - `refreshStatus()` → `GET /getvolume?did=xxx` → 数值 `volume`
  - 控制
    - 播放：`resumeMusic()` → `POST /cmd {did, cmd: 播放}`；必要时回退 `POST /playmusiclist`
    - 暂停：`pauseMusic()` → `POST /cmd {did, cmd: 暂停}`
    - 上一首/下一首：`POST /cmd {did, cmd: 上一首|下一首}`
    - 关机：`shutdown()` → `POST /cmd {did, cmd: 关机}`
    - 设置音量：`setVolume()` → `POST /setvolume {did, volume}`
    - 切换模式：`switchPlayMode()` → `POST /cmd {did, cmd: set_play_type_seq|set_play_type_all|set_play_type_one|set_play_type_rnd}`
  - 直接播放音乐
    - `playMusic(did, musicName?, searchKey?)` → `POST /playmusic`
- **数据模型**
  - `PlayingMusic`: `ret`, `is_playing`, `cur_music`, `cur_playlist`, `offset`, `duration`
  - `Device`: `id`（优先 `miotDID`，退化为 `deviceID`）、`name`、`isOnline`、`ip`、`type`

### 搜索页 `MusicSearchPage`
- **功能**
  - 展示搜索结果列表，点击播放
- **交互**
  - 从 `MainPage` 顶部搜索框驱动：`musicSearchProvider.searchMusic(query)`
  - 若未选设备，弹 Snackbar 提示
- **状态/Provider**
  - `musicSearchProvider`（`MusicSearchState`）：`searchResults`、`isLoading`、`error`、`searchQuery`
- **接口**
  - `GET /searchmusic?name=xxx` → 返回 `List<dynamic>`（兼容 Map/String）
  - 点击播放 → `playbackProvider.playMusic(did, musicName)`
- **数据模型**
  - `Music`: `name`, `title?`, `artist?`, `album?`, `duration?`, `picture?`

### 播放列表页 `PlaylistPage`
- **功能**
  - 展示播放列表集合（名称与数量）
  - 新建播放列表
  - 下钻/播放（TODO：详情页与整表播放）
  - 下拉刷新
- **状态/Provider**
  - `playlistProvider`（`PlaylistState`）：`playlists`、`currentPlaylist`、`currentPlaylistMusics`、`isLoading`、`error`
- **初始化/联动**
  - 登录成功后自动加载列表；退出清空
- **接口**
  - 获取列表名：`GET /playlistnames`（List/Map 任一）+ `GET /musiclist`（聚合，含“全部/收藏/最近新增”等）
  - 获取列表内容：优先 `GET /musiclist` 的键；否则 `GET /playlistmusics?name=xxx`（含 `music_list|musics|songs`）
  - 播放列表播放：`POST /playmusiclist {did, listname, musicname?}`
  - 创建/删除列表：`POST /playlistadd {name}`、`POST /playlistdel {name}`
  - 重命名/增删歌曲（接口已在 Service，UI 待用）：
    - `POST /playlistupdatename {oldname, newname}`
    - `POST /playlistaddmusic {name, music_list}`
    - `POST /playlistdelmusic {name, music_list}`
- **数据模型**
  - `Playlist`: `name`, `musicList?`, `count?`

### 音乐库页 `MusicLibraryPage`
- **功能**
  - 本地音乐库浏览、搜索过滤、本地删除、详情弹窗、播放
  - 首次加载动画、刷新、空/错误态处理
- **状态/Provider**
  - `musicLibraryProvider`（`MusicLibraryState`）：`musicList`、`filteredMusicList`、`searchQuery`、`isLoading`、`error`
- **接口**
  - 列表数据：`GET /musiclist`（Map，容忍多种字段：`所有歌曲`/`全部`/`music_list`/`songs`/`data` 等；兜底取第一个非空 `List` 字段）
  - 删除音乐：`POST /delmusic {name}`
  - 播放音乐：`playbackProvider.playMusic(did, musicName)`
- **UI 组件**
  - `MusicListItem`（支持封面 `picture`，点击播放/更多菜单）

### 网络层与错误
- **基础**
  - `DioClient` 持有 `baseUrl` 与 `Basic Auth`，统一超时与头，打印请求/响应日志
  - 错误映射为 `AppException` 子类（鉴权失败、网络不可达、404、422、500 等）
- **服务**
  - `MusicApiService` 封装所有接口（见 `lib/data/services/music_api_service.dart`），Provider 仅与 Service 交互

### 数据模型
- `Music`、`PlayingMusic`、`Playlist`、`Device`（`json_serializable`）
- 解析兼容：搜索与音乐库结果均兼容 `String`/`Map` 混合

### 状态流与页面关系
- 登录成功 → `AuthAuthenticated` 暴露 `apiService` → 各 Provider 读 `apiServiceProvider`
- `MainPage` 切 Tab 使用 `IndexedStack`，不销毁页面以保持状态
- 控制面板在播放中每 3 秒刷新播放状态

### 重构建议
- **路由与依赖注入**
  - 引入统一路由（如 `go_router`），按页面解耦
  - 用 DI 注入 `MusicApiService`，弱化 `authProvider` 耦合
- **Provider 关注点分离**
  - 将设备管理从 `playbackProvider` 拆出为 `deviceProvider`
  - 将“播放模式/进度/状态轮询”与“命令触发”拆分，避免 `PlaybackState` 过重
- **API 响应适配器**
  - 建立专用适配层，将 Map/List/String 统一收敛为模型，避免分散在 Provider 中
- **错误/Loading 统一**
  - 采用 `AsyncValue` 或 Result 类型，减少手写 `isLoading/error` 与 SnackBar 重复
- **可测试性**
  - Service 接口抽象、引入仓库层，配合 fake/mock 做单元与集成测试
- **进度条拖动**
  - 等服务端 `seek` 接口后，在进度条 `onChanged` 中调用
- **列表页补完**
  - `PlaylistPage` 支持详情页、批量添加/删除音乐、整表播放

### 接口一览（按路径）
- **版本/状态**
  - `GET /getversion`
  - `GET /cmdstatus`
- **播放/设备/音量**
  - `GET /playingmusic?did`
  - `POST /cmd {did, cmd}`
  - `POST /playmusic {did, musicname?, searchkey?}`
  - `GET /getsetting?need_device_list=true`
  - `GET /getvolume?did` / `POST /setvolume {did, volume}`
- **音乐库**
  - `GET /musiclist`
  - `GET /musicinfo?name&musictag`
  - `GET /musicinfos?name[]=...&musictag`
  - `POST /setmusictag`
  - `POST /delmusic {name}`
  - `GET /searchmusic?name`
- **URL/TTS**
  - `GET /playurl?did&url`
  - `GET /playtts?did&text`
- **播放列表**
  - `GET /playlistnames`
  - `GET /playlistmusics?name`
  - `POST /playmusiclist {did, listname, musicname?}`
  - `POST /playlistadd {name}` / `POST /playlistdel {name}`
  - `POST /playlistupdatename {oldname, newname}`
  - `POST /playlistaddmusic {name, music_list}` / `POST /playlistdelmusic {name, music_list}`

### 关键文件映射（路径）
- 页面：`lib/presentation/pages/*`
- Provider：`lib/presentation/providers/*`
- 网络：`lib/core/network/dio_client.dart`、`lib/data/services/music_api_service.dart`
- 模型：`lib/data/models/*`
- 常量：`lib/core/constants/app_constants.dart`
- 入口：`lib/main.dart`

### 说明
- 文档用于“页面-状态-接口”的契约固化，便于分阶段重构与联调。
- 如需，我可以基于本文档拆出第一阶段重构任务（路由/DI + Provider 拆分）并直接提交代码改造。



